<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimation des Prix au m² en France</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Cesium.js"></script>
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Widgets/widgets.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(90deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header img {
            width: 120px;
            height: auto;
            transition: transform 0.3s ease;
        }

        header img:hover {
            transform: scale(1.1);
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-left: 20px;
            flex-grow: 1;
            text-align: center;
        }

        .tab {
            display: flex;
            justify-content: center;
            background: #ffffff;
            border-bottom: 2px solid #3498db;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 5px 0;
            position: sticky;
            top: 70px;
            z-index: 999;
        }

        .tab button {
            background: none;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 400;
            color: #7f8c8d;
            transition: all 0.3s ease;
            border-radius: 5px 5px 0 0;
            margin: 0 5px;
        }

        .tab button:hover {
            color: #3498db;
            background: #f0f0f0;
        }

        .tab button.active {
            color: #ffffff;
            background: #3498db;
            font-weight: 600;
        }

        .tabcontent {
            display: none;
            height: calc(95vh - 150px);
            width: 100%;
            position: relative;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        #Comparison.tabcontent {
            height: auto;
            min-height: calc(95vh - 150px);
            overflow: visible;
        }

        #map, #map3D, #mapComparison {
            height: 100%;
            width: 100%;
            border-radius: 8px;
        }

        .info.legend {
            background: #ffffff;
            padding: 12px;
            font-size: 12px;
            line-height: 18px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .info.legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        footer {
            text-align: center;
            background: linear-gradient(90deg, #2c3e50, #3498db);
            color: #ecf0f1;
            padding: 15px 0;
            font-size: 14px;
            margin-top: auto;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        footer a {
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: #ffffff;
            text-decoration: underline;
        }

        #legend3D, #controls3D {
            position: absolute;
            background: #ffffff;
            padding: 12px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            z-index: 998;
            border-left: 4px solid #3498db;
        }

        #legend3D {
            bottom: 20px;
            right: 20px;
        }

        #controls3D {
            top: 70px;
            left: 20px;
        }

        #controls3D select {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
        }

        .custom-popup {
            padding: 15px;
            background: linear-gradient(135deg, #ffffff, #f0f5ff);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3498db;
            max-width: 300px;
        }

        .custom-popup h3 {
            margin: 0 0 10px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }

        .custom-popup p {
            margin: 5px 0;
            font-size: 14px;
            color: #34495e;
        }

        .custom-popup a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        .custom-popup a:hover {
            text-decoration: underline;
            color: #2980b9;
        }

        .leaflet-tooltip {
            font-size: 12px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 5px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: #2c3e50;
            font-weight: 500;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .leaflet-popup-tip {
            background: linear-gradient(135deg, #ffffff, #f0f5ff);
            border-left: 1px solid #3498db;
        }

        /* Désactiver les effets de surbrillance par défaut de Leaflet pour les clics */
        .leaflet-interactive:focus,
        .leaflet-interactive:active {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Éviter les conflits avec les styles dynamiques appliqués par JavaScript */
        .leaflet-overlay-pane path {
            stroke: black;
            stroke-width: 1px;
            /* Ne pas utiliser !important pour permettre à setStyle de fonctionner */
        }

        /* Supprimer toute bordure ou effet de surbrillance spécifique au popup */
        .leaflet-popup-content-wrapper {
            border: none !important;
        }

        .leaflet-popup-tip {
            border: none !important;
            background: transparent !important;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: none;
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Comparison Tab Styles */
        .comparison-container {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #e6f0fa 100%);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #3498db;
            color: #fff;
            border-radius: 8px;
        }

        .comparison-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .comparison-stats {
            font-size: 14px;
            font-weight: 400;
        }

        .comparison-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            z-index: 500;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }

        #yearSlider {
            width: 200px;
            cursor: pointer;
        }

        #yearDisplay {
            margin-left: 10px;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }

        #deptSearch {
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
            width: 200px;
        }

        .dept-suggestions {
            position: absolute;
            list-style: none;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 501;
            width: 200px;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 5px;
        }

        .dept-suggestions li {
            padding: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .dept-suggestions li:hover {
            background: #f0f0f0;
        }

        .comparison-map-container {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-bottom: 15px;
        }

        .comparison-chart-container {
            height: 200px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 500;
        }

        #mapComparison {
            height: 100%;
            width: 100%;
        }

        .leaflet-control-zoom {
            z-index: 400 !important;
        }

        .leaflet-control {
            z-index: 400 !important;
        }

        /* Map2D Specific Styles */
        .leaflet-container .leaflet-control-search {
            background: #ffffff;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
            font-family: 'Poppins', sans-serif;
        }

        .leaflet-control-search input {
            border: 1px solid #ddd;
            padding: 6px;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }

        .leaflet-control-search ul {
            list-style: none;
            margin: 5px 0 0;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .leaflet-control-search li {
            padding: 6px 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .leaflet-control-search li:hover {
            background: #f0f0f0;
        }

        .leaflet-control-reset {
            background: #ffffff;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            transition: background 0.3s ease;
        }

        .leaflet-control-reset:hover {
            background: #f0f0f0;
        }

        .leaflet-control-price-filter {
            background: #ffffff;
            padding: 12px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
            font-family: 'Poppins', sans-serif;
            width: 200px;
        }

        .leaflet-control-price-filter label {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 8px;
            display: block;
        }

        .leaflet-control-price-filter select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .leaflet-control-stats {
            background: #ffffff;
            padding: 12px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
            font-family: 'Poppins', sans-serif;
            width: 250px;
            font-size: 14px;
            color: #2c3e50;
        }

        .leaflet-control-stats h4 {
            margin: 0 0 10px;
            font-size: 16px;
            font-weight: 600;
            color: #3498db;
        }

        .leaflet-control-stats p {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            header h1 { font-size: 20px; }
            header img { width: 90px; }
            .tab button { padding: 10px 15px; font-size: 14px; }
            .tabcontent { height: calc(85vh - 120px); padding: 10px; max-width: 95%; }
            #Comparison.tabcontent { height: auto; min-height: calc(85vh - 120px); }
            .comparison-title { font-size: 20px; }
            .comparison-controls { flex-direction: column; }
            .comparison-map-container { height: 400px; }
            .comparison-chart-container { height: 150px; }
            .leaflet-control-search input,
            .leaflet-control-price-filter,
            .leaflet-control-stats { width: 180px; }
        }
    </style>
</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/Logo_site.jpg" alt="Logo_site">
    <h1>Estimation des Prix au m² en France</h1>
</header>

<div class="tab">
    <button class="tablinks" onclick="openTab(event, 'Map2D')" id="defaultOpen">Carte 2D</button>
    <button class="tablinks" onclick="openTab(event, 'Map3D')">Carte 3D des prix par commune</button>
    <button class="tablinks" onclick="openTab(event, 'Histogram')">Histogramme</button>
    <button class="tablinks" onclick="openTab(event, 'Comparison')">Comparaison 2014-2023</button>
</div>

<div id="Map2D" class="tabcontent">
    <div id="map"></div>
</div>

<div id="Map3D" class="tabcontent">
    <div id="map3D">
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<div id="Histogram" class="tabcontent">
    <canvas id="priceHistogram" width="800" height="400"></canvas>
</div>

<div id="Comparison" class="tabcontent">
    <div id="comparisonContainer" class="comparison-container">
        <div class="comparison-header">
            <h2 class="comparison-title">Comparaison des Prix au m² (2014-2023)</h2>
            <div class="comparison-stats">
                <p><strong>Moyenne nationale :</strong> <span id="nationalAverage">Chargement...</span> €/m²</p>
            </div>
        </div>
        <div class="comparison-controls">
            <div class="control-group">
                <label for="yearSlider">Année :</label>
                <input type="range" id="yearSlider" min="2014" max="2023" value="2023" oninput="updateYearSlider()">
                <span id="yearDisplay">2023</span>
            </div>
            <div class="control-group">
                <label for="deptSearch">Rechercher un département :</label>
                <input type="text" id="deptSearch" placeholder="Ex: 75 ou Paris" oninput="filterDepartments()">
                <ul id="deptSuggestions" class="dept-suggestions"></ul>
            </div>
        </div>
        <div class="comparison-map-container">
            <div id="mapComparison" class="comparison-map"></div>
        </div>
        <div class="comparison-chart-container">
            <canvas id="priceTrendChart"></canvas>
        </div>
    </div>
</div>

<footer>
    <p>© 2025 Votre Agence Immobilière - <a href="#">Contactez-nous</a></p>
</footer>

<script>
// Global Variables
let map = null;
let departementsLayer = null;
let communesLayer = null;
let prixCommuneData = {};
let mapComparison = null;
let priceTrendChart = null;
let highlightedDeptLayer = null;
let deptNames = {};
let communeNames = {};

// Tab Management
function openTab(evt, tabName) {
    const tabcontent = document.getElementsByClassName("tabcontent");
    const tablinks = document.getElementsByClassName("tablinks");

    for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";

    if (tabName === 'Map3D' && !window.cesiumInitialized) {
        initCesium();
        window.cesiumInitialized = true;
    } else if (tabName === 'Histogram' && !window.histogramInitialized) {
        initHistogram();
        window.histogramInitialized = true;
    } else if (tabName === 'Comparison' && !window.comparisonInitialized) {
        initComparison();
        window.comparisonInitialized = true;
    }
}

document.getElementById("defaultOpen").click();

// Utility Functions
function getColor(prix) {
    return prix < 1000 ? '#F5F5DC' :
           prix > 4000 ? '#800026' :
           prix > 3500 ? '#BD0026' :
           prix > 3000 ? '#E31A1C' :
           prix > 2500 ? '#FC4E2A' :
           prix > 2000 ? '#FD8D3C' :
           prix > 1500 ? '#FEB24C' :
           prix >= 1000 ? '#FED976' :
                          '#808080';
}

function getWikipediaUrl(communeName) {
    if (typeof communeName !== 'string' || !communeName) {
        return 'https://fr.wikipedia.org/wiki/Nom_non_défini';
    }
    const formattedName = encodeURIComponent(communeName.replace(/ /g, '_'));
    return `https://fr.wikipedia.org/wiki/${formattedName}`;
}

// 2D Map (2023)
document.addEventListener('DOMContentLoaded', function() {
    map = L.map('map', {
        zoomAnimation: true,
        zoomDelta: 0.5,
        zoomSnap: 0.5,
        maxZoom: 14,
        minZoom: 5
    }).setView([46.5, 2.0], 5.5);

    const initialView = { center: [46.5, 2.0], zoom: 5.5 };

    const Esri_WorldGrayCanvas = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri — Esri, DeLorme, NAVTEQ',
        maxZoom: 16
    }).addTo(map);

    let prixData = {};

    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_departement.csv').then(response => response.text()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_commune.csv').then(response => response.text()),
        fetch('https://www.data.gouv.fr/fr/datasets/r/fb3580f6-e875-408d-809a-ad22fc418581').then(response => response.json())
    ]).then(([deptCsvText, geojsonData, communeCsvText, communeGeojsonData]) => {
        // Process department data (2023)
        let deptRows = deptCsvText.split("\n").map(row => row.split(";"));
        deptRows.forEach(row => {
            let code_dep = row[0]?.trim();
            let prix = parseFloat(row[1]);
            if (code_dep && !isNaN(prix)) prixData[code_dep] = prix;
        });

        // Process commune data
        let communeRows = communeCsvText.split("\n").map(row => row.split(";"));
        communeRows.forEach(row => {
            let code_commune = row[0]?.trim().padStart(5, '0');
            let prix = parseFloat(row[1]);
            if (code_commune && !isNaN(prix)) prixCommuneData[code_commune] = prix;
        });

        // Store department names
        geojsonData.features.forEach(feature => {
            let code = feature.properties.code.toString().trim();
            deptNames[code] = feature.properties.nom;
        });

        // Store commune names and coordinates for search
        communeGeojsonData.features.forEach(feature => {
            let codeCommune = feature.properties.codgeo;
            let communeName = feature.properties.libgeo || 'Nom non défini';
            let depCode = feature.properties.dep ? feature.properties.dep.toString().padStart(2, '0') : null;
            let coordinates = null;

            if (feature.geometry.type === "Polygon") {
                coordinates = feature.geometry.coordinates[0][0];
            } else if (feature.geometry.type === "MultiPolygon") {
                coordinates = feature.geometry.coordinates[0][0][0];
            }

            if (coordinates) {
                communeNames[codeCommune] = {
                    name: communeName,
                    dep: depCode,
                    depName: deptNames[depCode] || 'Inconnu',
                    lat: coordinates[1],
                    lng: coordinates[0]
                };
            }
        });

        function getLayerStyle(feature, prixDataSource) {
            let code = feature.properties.code ? feature.properties.code.toString().trim() : feature.properties.codgeo;
            let prix = prixDataSource[code];
            let fillColor = getColor(prix);
            let isVisible = true;

            const priceFilter = document.getElementById('priceFilter')?.value;
            if (priceFilter) {
                const [min, max] = priceFilter.split('-').map(Number);
                isVisible = prix >= min && (max ? prix <= max : true);
                console.log(`Code: ${code}, Prix: ${prix}, Min: ${min}, Max: ${max}, IsVisible: ${isVisible}`); // Log pour déboguer le filtre
            }

            return {
                fillColor: prix !== undefined ? fillColor : '#808080',
                weight: 1,
                opacity: 1,
                color: 'black',
                fillOpacity: isVisible ? 0.7 : 0
            };
        }

        function updateLayer() {
            if (departementsLayer) map.removeLayer(departementsLayer);
            if (communesLayer) map.removeLayer(communesLayer);

            departementsLayer = L.geoJSON(geojsonData, {
                style: function(feature) {
                    return getLayerStyle(feature, prixData);
                },
                interactive: true,
                onEachFeature: function(feature, layer) {
                    let code = feature.properties.code.toString().padStart(2, '0');
                    let prix = prixData[code] ? prixData[code].toFixed(1) + " €/m²" : "Donnée non disponible";
                    let nom = feature.properties.nom || 'Nom non défini';

                    // Stocker le style initial pour pouvoir le restaurer
                    const initialStyle = getLayerStyle(feature, prixData);
                    layer.defaultStyle = initialStyle;

                    const popupContent = `
                        <div class="custom-popup">
                            <h3>${nom}</h3>
                            <p><strong>Code :</strong> ${code}</p>
                            <p><strong>Prix moyen (2023) :</strong> ${prix}</p>
                        </div>
                    `;

                    layer.bindTooltip(`${nom}<br>${prix}`, { direction: 'top', offset: [0, -10] });

                    layer.on('mouseover', function() {
                        console.log(`Mouseover on ${nom} (Code: ${code})`); // Log pour déboguer l'événement
                        layer.setStyle({
                            weight: 3,
                            color: '#000',
                            fillOpacity: 1
                        });
                        layer.openTooltip();
                        updateStatsPanel(nom, code, prix);
                    });

                    layer.on('mouseout', function() {
                        console.log(`Mouseout on ${nom} (Code: ${code})`); // Log pour déboguer l'événement
                        layer.setStyle(layer.defaultStyle);
                        layer.closeTooltip();
                        updateStatsPanel();
                    });

                    layer.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        const bounds = layer.getBounds();
                        map.fitBounds(bounds, { maxZoom: 9, animate: true });
                        loadCommuneLayer(code);
                        layer.setStyle({
                            weight: 1,
                            color: 'black',
                            fillOpacity: 0.7
                        });
                        layer.bindPopup(popupContent, {
                            className: 'custom-popup',
                            autoPan: true,
                            closeOnClick: true,
                            autoClose: true
                        }).openPopup();
                    });

                    layer.on('popupclose', function() {
                        layer.setStyle({
                            weight: 1,
                            color: 'black',
                            fillOpacity: 0.7
                        });
                    });
                }
            }).addTo(map);

            // Forcer le rafraîchissement des styles après le chargement initial
            departementsLayer.eachLayer(function(layer) {
                layer.setStyle(getLayerStyle(layer.feature, prixData));
            });

            updateLegend();
        }

        function loadCommuneLayer(codeDepartement) {
            if (communesLayer) {
                map.removeLayer(communesLayer);
            }

            communesLayer = L.geoJSON(communeGeojsonData, {
                filter: function(feature) {
                    let dep = feature.properties.dep ? feature.properties.dep.toString().padStart(2, '0') : null;
                    return dep === codeDepartement;
                },
                style: function(feature) {
                    return getLayerStyle(feature, prixCommuneData);
                },
                interactive: true,
                onEachFeature: function(feature, layer) {
                    let codeCommune = feature.properties.codgeo;
                    let prix = prixCommuneData[codeCommune] ? prixCommuneData[codeCommune].toFixed(1) + " €/m²" : "Donnée non disponible";
                    let communeName = feature.properties.libgeo || 'Nom non défini';
                    let depCode = feature.properties.dep ? feature.properties.dep.toString().padStart(2, '0') : null;

                    // Stocker le style initial pour pouvoir le restaurer
                    const initialStyle = getLayerStyle(feature, prixCommuneData);
                    layer.defaultStyle = initialStyle;

                    const popupContent = `
                        <div class="custom-popup">
                            <h3>${communeName}</h3>
                            <p><strong>Code :</strong> ${codeCommune}</p>
                            <p><strong>Département :</strong> ${deptNames[depCode] || 'Inconnu'} (Dép. ${depCode})</p>
                            <p><strong>Prix moyen :</strong> ${prix}</p>
                            <a href="${getWikipediaUrl(communeName)}" target="_blank">Voir sur Wikipédia</a>
                        </div>
                    `;

                    layer.bindTooltip(`${communeName}<br>${prix}`, { direction: 'top', offset: [0, -10] });

                    layer.on('mouseover', function() {
                        console.log(`Mouseover on commune ${communeName} (Code: ${codeCommune})`); // Log pour déboguer l'événement
                        if (prixCommuneData[codeCommune] !== undefined) {
                            layer.setStyle({
                                weight: 3,
                                color: '#000',
                                fillOpacity: 1
                            });
                            layer.openTooltip();
                            updateStatsPanel(communeName, codeCommune, prix, deptNames[depCode]);
                        }
                    });

                    layer.on('mouseout', function() {
                        console.log(`Mouseout on commune ${communeName} (Code: ${codeCommune})`); // Log pour déboguer l'événement
                        if (prixCommuneData[codeCommune] !== undefined) {
                            layer.setStyle(layer.defaultStyle);
                            layer.closeTooltip();
                            updateStatsPanel();
                        }
                    });

                    layer.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        map.fitBounds(layer.getBounds(), { maxZoom: 13, animate: true });
                        layer.setStyle({
                            weight: 1,
                            color: 'black',
                            fillOpacity: 0.7
                        });
                        layer.bindPopup(popupContent, {
                            className: 'custom-popup',
                            autoPan: true,
                            closeOnClick: true,
                            autoClose: true
                        }).openPopup();
                    });

                    layer.on('popupclose', function() {
                        layer.setStyle({
                            weight: 1,
                            color: 'black',
                            fillOpacity: 0.7
                        });
                    });
                }
            }).addTo(map);

            // Forcer le rafraîchissement des styles après le chargement initial
            communesLayer.eachLayer(function(layer) {
                layer.setStyle(getLayerStyle(layer.feature, prixCommuneData));
            });
        }

        function updateLegend() {
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [1000, 1500, 2000, 2500, 3000, 3500, 4000];
                let html = `<b>Prix du m² (2023)</b><br>`;
                html += '<i style="background:#F5F5DC"></i> < 1000 €/m²<br>';
                for (let i = 0; i < grades.length; i++) {
                    html += `<i style="background:${getColor(grades[i] + 1)}"></i> ${grades[i]}${grades[i + 1] ? '–' + grades[i + 1] : '+'} €/m²<br>`;
                }
                html += '<br><i style="background:#808080"></i> Données non disponibles<br>';
                div.innerHTML = html;
                return div;
            };
            if (map._legend) map.removeControl(map._legend);
            map._legend = legend.addTo(map);
        }

        // Search Control
        const searchControl = L.control({ position: 'topleft' });
        searchControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-search');
            div.innerHTML = `
                <input type="text" id="mapSearch" placeholder="Rechercher un département/commune...">
                <ul id="mapSuggestions"></ul>
            `;
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        searchControl.addTo(map);

        document.getElementById('mapSearch').addEventListener('input', function() {
            const input = this.value.toLowerCase();
            const suggestions = document.getElementById('mapSuggestions');
            suggestions.innerHTML = '';

            if (input.length < 2) {
                suggestions.style.display = 'none';
                return;
            }

            // Search departments
            const deptMatches = Object.entries(deptNames).filter(([code, name]) =>
                code.includes(input) || name.toLowerCase().includes(input)
            );

            // Search communes
            const communeMatches = Object.entries(communeNames).filter(([code, info]) =>
                info.name.toLowerCase().includes(input) || code.includes(input)
            );

            const matches = [...deptMatches.map(([code, name]) => ({ type: 'dept', code, name })),
                            ...communeMatches.map(([code, info]) => ({ type: 'commune', code, ...info }))];

            matches.slice(0, 5).forEach(match => {
                const li = document.createElement('li');
                li.textContent = match.type === 'dept' ? `${match.name} (Dép. ${match.code})` : `${match.name} (${match.depName})`;
                li.onclick = () => {
                    if (match.type === 'dept') {
                        const feature = Object.values(departementsLayer._layers).find(layer =>
                            layer.feature.properties.code.toString().padStart(2, '0') === match.code
                        );
                        if (feature) {
                            map.fitBounds(feature.getBounds(), { maxZoom: 9, animate: true });
                            loadCommuneLayer(match.code);
                        }
                    } else {
                        map.setView([match.lat, match.lng], 13, { animate: true });
                        loadCommuneLayer(match.dep);
                    }
                    document.getElementById('mapSearch').value = '';
                    suggestions.style.display = 'none';
                };
                suggestions.appendChild(li);
            });

            suggestions.style.display = matches.length > 0 ? 'block' : 'none';
        });

        // Reset View Control
        const resetControl = L.control({ position: 'topleft' });
        resetControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-reset');
            div.innerHTML = 'Réinitialiser la vue';
            L.DomEvent.on(div, 'click', () => {
                map.setView(initialView.center, initialView.zoom, { animate: true });
                if (communesLayer) map.removeLayer(communesLayer);
            });
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        resetControl.addTo(map);

        // Price Filter Control
        const priceFilterControl = L.control({ position: 'topright' });
        priceFilterControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-price-filter');
            div.innerHTML = `
                <label>Filtrer par prix :</label>
                <select id="priceFilter">
                    <option value="">Tous les prix</option>
                    <option value="0-1000">0 - 1000 €/m²</option>
                    <option value="1000-1500">1000 - 1500 €/m²</option>
                    <option value="1500-2000">1500 - 2000 €/m²</option>
                    <option value="2000-2500">2000 - 2500 €/m²</option>
                    <option value="2500-3000">2500 - 3000 €/m²</option>
                    <option value="3000-3500">3000 - 3500 €/m²</option>
                    <option value="3500-4000">3500 - 4000 €/m²</option>
                    <option value="4000">> 4000 €/m²</option>
                </select>
            `;
            L.DomEvent.on(div.querySelector('#priceFilter'), 'change', () => {
                console.log("Price filter changed to:", document.getElementById('priceFilter').value); // Log pour déboguer le changement de filtre
                // Mettre à jour les styles des couches existantes sans recréer les couches
                if (departementsLayer) {
                    departementsLayer.eachLayer(function(layer) {
                        const newStyle = getLayerStyle(layer.feature, prixData);
                        layer.setStyle(newStyle);
                        layer.defaultStyle = newStyle; // Mettre à jour le style par défaut
                    });
                }
                if (communesLayer) {
                    communesLayer.eachLayer(function(layer) {
                        const newStyle = getLayerStyle(layer.feature, prixCommuneData);
                        layer.setStyle(newStyle);
                        layer.defaultStyle = newStyle; // Mettre à jour le style par défaut
                    });
                }
            });
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        priceFilterControl.addTo(map);

        // Stats Panel
        const statsPanel = L.control({ position: 'bottomleft' });
        statsPanel.onAdd = function() {
            const div = L.DomUtil.create('div', 'leaflet-control-stats');
            div.id = 'statsPanel';
            div.innerHTML = `
                <h4>Statistiques</h4>
                <p>Sélectionnez un département ou une commune pour voir les détails.</p>
            `;
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        statsPanel.addTo(map);

        function updateStatsPanel(name, code, prix, depName) {
            const statsPanel = document.getElementById('statsPanel');
            if (!name) {
                statsPanel.innerHTML = `
                    <h4>Statistiques</h4>
                    <p>Sélectionnez un département ou une commune pour voir les détails.</p>
                `;
                return;
            }

            if (depName) {
                // Commune stats
                statsPanel.innerHTML = `
                    <h4>Commune : ${name}</h4>
                    <p><strong>Code :</strong> ${code}</p>
                    <p><strong>Département :</strong> ${depName}</p>
                    <p><strong>Prix moyen :</strong> ${prix}</p>
                `;
            } else {
                // Department stats
                const avgPrice = Object.values(prixData).reduce((a, b) => a + b, 0) / Object.keys(prixData).length;
                statsPanel.innerHTML = `
                    <h4>Département : ${name}</h4>
                    <p><strong>Code :</strong> ${code}</p>
                    <p><strong>Prix moyen (2023) :</strong> ${prix}</p>
                    <p><strong>Moyenne nationale :</strong> ${avgPrice.toFixed(1)} €/m²</p>
                `;
            }
        }

        updateLayer();
    }).catch(error => {
        console.error('Erreur lors du chargement des données initiales pour Leaflet :', error);
    });
});

// 3D Map (Cesium)
// 3D Map (Cesium)
function initCesium() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    loadingSpinner.style.display = 'block';

    const viewer = new Cesium.Viewer('map3D', {
        imageryProvider: new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' }),
        terrainProvider: null,
        baseLayerPicker: false,
        geocoder: false,
        homeButton: true,
        sceneModePicker: true,
        navigationHelpButton: true,
        animation: false,
        timeline: false,
        fullscreenButton: true
    });

    viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString('#87CEEB');
    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(2.5, 46.5, 400000),
        orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-60.0) }
    });

    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_commune.csv').then(response => response.text()),
        fetch('https://www.data.gouv.fr/fr/datasets/r/fb3580f6-e875-408d-809a-ad22fc418581').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/ne_50m_admin_0_countries.geojson').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json())
    ]).then(([csvText, communeGeojsonData, countriesGeojsonData, deptGeojsonData]) => {
        let rows = csvText.split("\n").map(row => row.split(";"));
        rows.forEach(row => {
            let code_commune = row[0]?.trim().padStart(5, '0');
            let prix = parseFloat(row[1]);
            if (code_commune && !isNaN(prix)) prixCommuneData[code_commune] = prix;
        });

        Cesium.GeoJsonDataSource.load(countriesGeojsonData, {
            clampToGround: true,
            stroke: Cesium.Color.BLACK,
            strokeWidth: 1,
            fill: Cesium.Color.GRAY.withAlpha(0.3)
        }).then(dataSource => {
            viewer.dataSources.add(dataSource);
        });

        Cesium.GeoJsonDataSource.load(communeGeojsonData, { clampToGround: false }).then(dataSource => {
            viewer.dataSources.add(dataSource);
            const entities = dataSource.entities.values;
            const domDepartments = ["971", "972", "973", "974", "975", "976", "977", "978", "986", "987", "988"];

            entities.forEach(entity => {
                const dep = entity.properties._dep ? entity.properties._dep._value.toString().padStart(2, '0') : null;
                if (dep && domDepartments.includes(dep)) {
                    entity.show = false;
                    return;
                }

                const code = entity.properties._codgeo._value;
                const prix = prixCommuneData[code];
                const height = prix !== undefined ? prix * 30 : 0;
                const fillColor = prix !== undefined ? Cesium.Color.fromCssColorString(getColor(prix)).withAlpha(1.0) : Cesium.Color.fromCssColorString('#808080').withAlpha(1.0);
                entity.polygon.material = fillColor;
                entity.polygon.outline = true;
                // Modifier ici : aligner la couleur du contour avec celle du remplissage
                entity.polygon.outlineColor = fillColor;
                entity.polygon.extrudedHeight = height;
                entity.polygon.height = 0;

                const communeName = entity.properties._libgeo ? entity.properties._libgeo._value : 'Nom non défini';
                const prixText = prix !== undefined ? prix.toFixed(1) + " €/m²" : "Donnée non disponible";
                entity.description = `
                    <div class="custom-popup">
                        <h3>${communeName}</h3>
                        <p><strong>Code commune :</strong> ${code}</p>
                        <p><strong>Prix moyen :</strong> ${prixText}</p>
                        <a href="${getWikipediaUrl(communeName)}" target="_blank">Voir sur Wikipédia</a>
                    </div>
                `;
            });

            const legendDiv = document.createElement('div');
            legendDiv.id = 'legend3D';
            legendDiv.innerHTML = `
                <b>Prix du m²</b><br>
                <div><span style="display:inline-block;width:18px;height:18px;background:#F5F5DC"></span> < 1000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FED976"></span> 1000–1500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FEB24C"></span> 1500–2000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FD8D3C"></span> 2000–2500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FC4E2A"></span> 2500–3000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#E31A1C"></span> 3000–3500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#BD0026"></span> 3500–4000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#800026"></span> > 4000 €/m²</div>
                <br><div><span style="display:inline-block;width:18px;height:18px;background:#808080"></span> Données non disponibles</div>
            `;
            document.getElementById('map3D').appendChild(legendDiv);

            const controlsDiv = document.createElement('div');
            controlsDiv.id = 'controls3D';
            controlsDiv.innerHTML = '<b>Sélectionner un département :</b>';
            const select = document.createElement('select');
            select.innerHTML = '<option value="">Toute la France</option>';
            deptGeojsonData.features.forEach(feature => {
                const option = document.createElement('option');
                option.value = feature.properties.code.toString().padStart(2, '0');
                option.text = feature.properties.nom;
                select.appendChild(option);
            });

            select.onchange = function() {
                const codeDep = select.value;
                if (codeDep) {
                    const depFeature = deptGeojsonData.features.find(f => f.properties.code.toString().padStart(2, '0') === codeDep);
                    const bounds = calculateBounds(depFeature);
                    viewer.camera.flyTo({ destination: bounds, duration: 1.5 });

                    entities.forEach(entity => {
                        const entityDep = entity.properties._dep ? entity.properties._dep._value.toString().padStart(2, '0') : null;
                        entity.show = entityDep === codeDep && !domDepartments.includes(entityDep);
                    });
                } else {
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(2.5, 46.5, 400000),
                        orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-60.0) },
                        duration: 1.5
                    });
                    entities.forEach(entity => {
                        const entityDep = entity.properties._dep ? entity.properties._dep._value.toString().padStart(2, '0') : null;
                        entity.show = !domDepartments.includes(entityDep);
                    });
                }
            };

            controlsDiv.appendChild(select);
            document.getElementById('map3D').appendChild(controlsDiv);
        });

        loadingSpinner.style.display = 'none';
    }).catch(error => {
        console.error('Erreur lors du chargement des données pour Cesium :', error);
        loadingSpinner.style.display = 'none';
    });

    function calculateBounds(feature) {
        let coordinates = feature.geometry.coordinates;
        let minLon = Infinity, maxLon = -Infinity, minLat = Infinity, maxLat = -Infinity;

        function processCoords(coords) {
            if (Array.isArray(coords[0])) {
                coords.forEach(subCoords => processCoords(subCoords));
            } else {
                let lon = coords[0];
                let lat = coords[1];
                minLon = Math.min(minLon, lon);
                maxLon = Math.max(maxLon, lon);
                minLat = Math.min(minLat, lat);
                maxLat = Math.max(maxLat, lat);
            }
        }

        if (feature.geometry.type === "Polygon") {
            processCoords(coordinates[0]);
        } else if (feature.geometry.type === "MultiPolygon") {
            coordinates.forEach(poly => processCoords(poly[0]));
        }

        return Cesium.Rectangle.fromDegrees(minLon, minLat, maxLon, maxLat);
    }
}

// Histogram
function initHistogram() {
    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_departement.csv').then(response => response.text()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json())
    ]).then(([csvText, geojsonData]) => {
        let prixData = {};
        let deptNames = {};

        let rows = csvText.split("\n").map(row => row.split(";"));
        rows.forEach(row => {
            let code_dep = row[0]?.trim();
            let prix = parseFloat(row[1]);
            if (code_dep && !isNaN(prix)) prixData[code_dep] = prix;
        });

        geojsonData.features.forEach(feature => {
            let code = feature.properties.code.toString().trim();
            deptNames[code] = feature.properties.nom;
        });

                let entries = Object.entries(prixData).sort((a, b) => {
            let codeA = a[0], codeB = b[0];
            if (codeA === "2A" || codeA === "2B") return codeB.startsWith("2") ? (codeA === "2A" ? -1 : 1) : -1;
            if (codeB === "2A" || codeB === "2B") return codeA.startsWith("2") ? (codeB === "2A" ? 1 : -1) : 1;
            return parseInt(codeA) - parseInt(codeB);
        });

        const labels = entries.map(entry => `Dép. ${entry[0]}`);
        const data = entries.map(entry => entry[1]);
        const codes = entries.map(entry => entry[0]);

        const ctx = document.getElementById('priceHistogram').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Prix au m² (€)',
                    data: data,
                    backgroundColor: 'rgba(52, 152, 219, 0.8)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Prix au m² (€)' } },
                    x: {
                        title: { display: true, text: 'Départements' },
                        ticks: { maxRotation: 90, minRotation: 90, callback: (value, index) => index % 2 === 0 ? labels[index] : '' }
                    }
                },
                plugins: {
                    title: { display: true, text: 'Prix moyen au m² par département en France', font: { size: 18 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let index = context.dataIndex;
                                let code = codes[index];
                                let nom = deptNames[code] || "Nom non disponible";
                                let prix = context.parsed.y.toFixed(1);
                                return `${nom} (Dép. ${code}) : ${prix} €/m²`;
                            }
                        }
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        let index = elements[0].index;
                        let code = codes[index];
                        openTab({ currentTarget: document.getElementsByClassName("tablinks")[0] }, 'Map2D');
                        setTimeout(() => {
                            const feature = Object.values(departementsLayer._layers).find(layer => 
                                layer.feature.properties.code.toString().padStart(2, '0') === code
                            );
                            if (feature) {
                                map.fitBounds(feature.getBounds(), { maxZoom: 9, animate: true });
                                loadCommuneLayer(code);
                            }
                        }, 1000);
                    }
                },
                maintainAspectRatio: false,
                responsive: true
            }
        });
    }).catch(error => {
        console.error('Erreur lors du chargement des données pour l\'histogramme :', error);
    });
}

// Comparison Tab (2014-2023)
function initComparison() {
    mapComparison = L.map('mapComparison', {
        zoomAnimation: true,
        zoomDelta: 0.5,
        zoomSnap: 0.5,
        maxZoom: 10,
        minZoom: 5
    }).setView([46.5, 2.0], 5.5);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri — Esri, DeLorme, NAVTEQ',
        maxZoom: 16
    }).addTo(mapComparison);

    let departementsLayer = null;
    let prixDataByYear = {};
    let deptNames = {};
    let deptGeojsonData = null;
    const years = Array.from({ length: 2023 - 2014 + 1 }, (_, i) => 2014 + i);

    // Load Department Names
    fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson')
        .then(response => response.json())
        .then(geojsonData => {
            geojsonData.features.forEach(feature => {
                let code = feature.properties.code.toString().padStart(2, '0');
                deptNames[code] = feature.properties.nom || 'Nom non défini';
            });
        }).catch(error => {
            console.error('Erreur lors du chargement des noms des départements :', error);
        });

    const fetchPromises = years.map(year => {
        let url = year === 2014 ? 
            'https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/Prix_m2_par_dep_2014.csv' :
            year === 2023 ? 
            'https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_departement.csv' :
            `https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_2014_a_2023/prix_m2_${year}.csv`;
        return fetch(url)
            .then(response => response.text())
            .then(text => ({ year, text }))
            .catch(error => {
                console.error(`Erreur pour ${year} :`, error);
                return { year, text: null };
            });
    });

    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/ne_50m_admin_0_countries.geojson').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json()),
        ...fetchPromises
    ]).then(([countriesGeojson, deptGeojsonDataResponse, ...yearData]) => {
        deptGeojsonData = deptGeojsonDataResponse;

        L.geoJSON(countriesGeojson, {
            style: { fillColor: '#f0f0f0', weight: 1, opacity: 1, color: '#666', fillOpacity: 0.8 }
        }).addTo(mapComparison);

        let deptCodes = deptGeojsonData.features.map(feature => feature.properties.code.toString().trim());

        yearData.forEach(({ year, text }) => {
            prixDataByYear[year] = {};
            if (!text) return;
            let delimiter = year === 2023 ? ";" : ",";
            let rows = text.split("\n").map(row => row.split(delimiter));
            let startIndex = (rows[0][1] && rows[0][1].trim() === "prix_m2") ? 1 : 0;

            rows.slice(startIndex).forEach(row => {
                if (row.length < 2) return;
                let code_dep = row[0]?.trim();
                let prix = parseFloat(row[1]);
                if (!code_dep || isNaN(prix)) return;
                code_dep = code_dep.padStart(2, '0');
                if (deptCodes.includes(code_dep)) prixDataByYear[year][code_dep] = prix;
            });
        });

        function updateLayer(year) {
            if (departementsLayer) mapComparison.removeLayer(departementsLayer);

            let prixData = prixDataByYear[year] || {};
            departementsLayer = L.geoJSON(deptGeojsonData, {
                style: function(feature) {
                    let code = feature.properties.code.toString().trim();
                    let prix = prixData[code];
                    return {
                        fillColor: prix !== undefined ? getColor(prix) : '#808080',
                        weight: 1,
                        opacity: 1,
                        color: 'black',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    let code = feature.properties.code.toString().padStart(2, '0');
                    let nom = deptNames[code] || 'Nom non défini';
                    let prix = prixData[code] ? prixData[code].toFixed(1) + " €/m²" : "Donnée non disponible";
                    layer.bindPopup(`
                        <div class="custom-popup">
                            <h3>${nom}</h3>
                            <p><strong>Code :</strong> ${code}</p>
                            <p><strong>Année :</strong> ${year}</p>
                            <p><strong>Prix moyen :</strong> ${prix}</p>
                        </div>
                    `);
                }
            }).addTo(mapComparison);

            if (highlightedDeptLayer) {
                const code = highlightedDeptLayer.feature.properties.code.toString().padStart(2, '0');
                highlightDepartment(code);
            }

            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [1000, 1500, 2000, 2500, 3000, 3500, 4000];
                let html = `<b>Prix du m² (${year})</b><br>`;
                html += '<i style="background:#F5F5DC"></i> < 1000 €/m²<br>';
                for (let i = 0; i < grades.length; i++) {
                    html += `<i style="background:${getColor(grades[i] + 1)}"></i> ${grades[i]}${grades[i + 1] ? '–' + grades[i + 1] : '+'} €/m²<br>`;
                }
                html += '<br><i style="background:#808080"></i> Données non disponibles<br>';
                div.innerHTML = html;
                return div;
            };
            if (mapComparison._legend) mapComparison.removeControl(mapComparison._legend);
            mapComparison._legend = legend.addTo(mapComparison);
        }

        function updatePriceTrendChart() {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');
            if (priceTrendChart) {
                priceTrendChart.destroy();
                priceTrendChart = null;
            }

            priceTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Prix moyen (€/m²)',
                        data: years.map(y => {
                            let data = prixDataByYear[y] || {};
                            return Object.values(data).reduce((a, b) => a + b, 0) / (Object.keys(data).length || 1);
                        }),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        x: { title: { display: true, text: 'Années' } },
                        y: { title: { display: true, text: 'Prix (€/m²)' }, beginAtZero: true }
                    }
                }
            });
        }

        function updateNationalAverage() {
            const year = document.getElementById('yearSlider').value;
            const data = prixDataByYear[year] || {};
            const average = Object.values(data).reduce((a, b) => a + b, 0) / (Object.keys(data).length || 1);
            document.getElementById('nationalAverage').textContent = average.toFixed(1);
        }

        function zoomToDepartment(code) {
            if (!deptGeojsonData) return;
            const feature = deptGeojsonData.features.find(f => f.properties.code.toString().padStart(2, '0') === code);
            if (feature) {
                mapComparison.fitBounds(L.geoJSON(feature).getBounds(), { maxZoom: 9, animate: true });
                highlightDepartment(code);
            }
        }

        function highlightDepartment(code) {
            if (highlightedDeptLayer) {
                departementsLayer.resetStyle(highlightedDeptLayer);
            }

            const layer = Object.values(departementsLayer._layers).find(l => 
                l.feature.properties.code.toString().padStart(2, '0') === code
            );

            if (layer) {
                layer.setStyle({
                    weight: 3,
                    color: '#ffffff',
                    opacity: 1
                });
                highlightedDeptLayer = layer;
            }
        }

        window.updateYearSlider = function() {
            const year = document.getElementById('yearSlider').value;
            document.getElementById('yearDisplay').textContent = year;
            updateLayer(year);
            updateNationalAverage();
            updatePriceTrendChart();
        };

        window.filterDepartments = function() {
            const input = document.getElementById('deptSearch').value.toLowerCase();
            const suggestions = document.getElementById('deptSuggestions');
            suggestions.innerHTML = '';
            if (input.length < 1) {
                suggestions.style.display = 'none';
                if (highlightedDeptLayer) {
                    departementsLayer.resetStyle(highlightedDeptLayer);
                    highlightedDeptLayer = null;
                }
                return;
            }
            const matches = Object.entries(deptNames).filter(([code, name]) =>
                code.includes(input) || name.toLowerCase().includes(input)
            );
            matches.slice(0, 5).forEach(([code, name]) => {
                const li = document.createElement('li');
                li.textContent = `${name} (Dép. ${code})`;
                li.onclick = () => {
                    zoomToDepartment(code);
                    document.getElementById('deptSearch').value = '';
                    suggestions.style.display = 'none';
                };
                suggestions.appendChild(li);
            });
            suggestions.style.display = matches.length > 0 ? 'block' : 'none';
        };

        updateLayer("2023");
        updateNationalAverage();
        updatePriceTrendChart();
    }).catch(error => {
        console.error('Erreur lors du chargement des données pour la comparaison :', error);
    });
}
</script>
</body>
</html>
