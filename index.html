<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimation des Prix au m² en France</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Cesium.js"></script>
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Widgets/widgets.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f4f4; 
        }
        header { 
            background-color: #2C3E50; 
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        header img { 
            width: 150px; 
            vertical-align: middle; 
            margin-left: 20px; 
        }
        header h1 { 
            font-size: 28px; 
            margin-left: 20px; 
            flex-grow: 1; 
        }
        .tab { 
            overflow: hidden; 
            border: 1px solid #ccc; 
            background-color: #f1f1f1; 
        }
        .tab button { 
            background-color: inherit; 
            float: left; 
            border: none; 
            outline: none; 
            cursor: pointer; 
            padding: 14px 16px; 
            transition: 0.3s; 
            font-size: 16px; 
        }
        .tab button:hover { 
            background-color: #ddd; 
        }
        .tab button.active { 
            background-color: #3498DB; 
            color: white; 
        }
        .tabcontent { 
            display: none; 
            height: calc(80vh - 60px); 
            width: 100%; 
            position: relative; 
        }
        #map, #map3D { 
            height: 100%; 
            width: 100%; 
        }
        .info.legend { 
            background: white; 
            padding: 10px; 
            font-size: 12px; 
            line-height: 18px; 
            border-radius: 5px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.2); 
        }
        .info.legend i { 
            width: 18px; 
            height: 18px; 
            float: left; 
            margin-right: 8px; 
            opacity: 0.7; 
        }
        footer { 
            text-align: center; 
            background-color: #2C3E50; 
            color: white; 
            padding: 10px 0; 
            font-size: 14px; 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
        }
        footer a { 
            color: #ECF0F1; 
            text-decoration: none; 
        }
        footer a:hover { 
            text-decoration: underline; 
        }
        #legend3D, #controls3D { 
            position: absolute; 
            background: white; 
            padding: 10px; 
            border-radius: 5px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.2); 
            font-size: 12px; 
            z-index: 1000; 
        }
        #legend3D { 
            bottom: 10px; 
            right: 10px; 
        }
        #controls3D { 
            top: 50px; 
            left: 10px; 
        }
        #controls3D select { 
            width: 100%; 
            padding: 5px; 
            margin-top: 5px; 
            box-sizing: border-box; 
        }
        .cesium-infoBox { 
            font-family: Arial, sans-serif; 
        }
        .custom-popup { 
            padding: 15px; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
            animation: fadeIn 0.3s ease; 
        }
        .custom-popup h3 { 
            margin: 0 0 10px; 
            color: #2C3E50; 
            font-size: 18px; 
        }
        .custom-popup p { 
            margin: 5px 0; 
            font-size: 14px; 
        }
        .custom-popup strong { 
            color: #555; 
        }
        .custom-popup a { 
            color: #3498DB; 
            text-decoration: none; 
        }
        .custom-popup a:hover { 
            text-decoration: underline; 
        }
        .leaflet-tooltip { 
            font-size: 12px; 
            padding: 5px; 
            background: rgba(255, 255, 255, 0.9); 
            border-radius: 3px; 
        }
        .leaflet-interactive:focus { 
            outline: none; 
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @media (max-width: 768px) {
            header h1 { font-size: 20px; }
            header img { width: 100px; }
            .tab button { padding: 10px 12px; font-size: 14px; }
        }
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: none;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498DB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/Logo_site.jpg" alt="Logo_site">
    <h1>Estimation des Prix au m² en France</h1>
</header>

<div class="tab">
    <button class="tablinks" onclick="openTab(event, 'Map2D')" id="defaultOpen">Carte 2D</button>
    <button class="tablinks" onclick="openTab(event, 'Map3D')">Carte 3D des prix par commune</button>
    <button class="tablinks" onclick="openTab(event, 'Histogram')">Histogramme</button>
</div>

<div id="Map2D" class="tabcontent">
    <div id="map"></div>
</div>

<div id="Map3D" class="tabcontent">
    <div id="map3D">
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<div id="Histogram" class="tabcontent">
    <canvas id="priceHistogram" width="800" height="400"></canvas>
</div>

<footer>
    <p>© 2025 Votre Agence Immobilière - <a href="#">Contactez-nous</a></p>
</footer>

<script>
// Variables globales pour accéder à la carte et aux couches
window.map = null;
window.departementsLayer = null;
window.communesLayer = null; // Ajout pour gérer la couche des communes globalement
window.prixCommuneData = {};

// Gestion des onglets
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";

    if (tabName === 'Map3D' && !window.cesiumInitialized) {
        if (typeof Cesium === 'undefined') {
            console.error("Cesium n'est pas chargé correctement. Vérifiez la balise script.");
            return;
        }
        initCesium();
        window.cesiumInitialized = true;
    } else if (tabName === 'Histogram' && !window.histogramInitialized) {
        initHistogram();
        window.histogramInitialized = true;
    }
}

document.getElementById("defaultOpen").click();

// Fonction utilitaire pour les couleurs
function getColor(prix) {
    return prix < 1000 ? '#F5F5DC' :
           prix > 4000 ? '#800026' :
           prix > 3500 ? '#BD0026' :
           prix > 3000 ? '#E31A1C' :
           prix > 2500 ? '#FC4E2A' :
           prix > 2000 ? '#FD8D3C' :
           prix > 1500 ? '#FEB24C' :
           prix >= 1000 ? '#FED976' :
                          '#808080';
}

// Fonction utilitaire pour générer les URLs Wikipédia
function getWikipediaUrl(communeName) {
    if (typeof communeName !== 'string' || !communeName) {
        console.warn(`communeName invalide : ${communeName}, type : ${typeof communeName}`);
        return 'https://fr.wikipedia.org/wiki/Nom_non_défini';
    }
    const formattedName = encodeURIComponent(communeName.replace(/ /g, '_'));
    const wikiUrl = `https://fr.wikipedia.org/wiki/${formattedName}`;
    return wikiUrl;
}

// Fonction globale pour charger les communes (déplacée hors de DOMContentLoaded)
function loadCommuneLayer(codeDepartement) {
    if (window.communesLayer) {
        window.map.removeLayer(window.communesLayer);
    }

    fetch('https://www.data.gouv.fr/fr/datasets/r/fb3580f6-e875-408d-809a-ad22fc418581')
    .then(response => response.json())
    .then(geojsonData => {
        console.log("Chargement des communes pour le département :", codeDepartement);
        window.communesLayer = L.geoJSON(geojsonData, {
            filter: function (feature) {
                let dep = feature.properties.dep ? feature.properties.dep.toString().padStart(2, '0') : null;
                return dep === codeDepartement;
            },
            style: function (feature) {
                let codeCommune = feature.properties.codgeo;
                let prix = window.prixCommuneData[codeCommune];
                let fillColor = prix !== undefined ? getColor(prix) : '#808080';
                return {
                    fillColor: fillColor,
                    weight: 1,
                    opacity: 1,
                    color: 'black',
                    fillOpacity: 0.7
                };
            },
            onEachFeature: function (feature, layer) {
                let codeCommune = feature.properties.codgeo;
                let prix = window.prixCommuneData[codeCommune] ? window.prixCommuneData[codeCommune].toFixed(1) + " €/m²" : "Donnée non disponible";
                let communeName = feature.properties.libgeo || 'Nom non défini';
                let tooltipContent = `${communeName}<br>${prix}`;

                layer.bindPopup(function () {
                    let wikiUrl = getWikipediaUrl(communeName);
                    return `
                        <b>Commune : ${communeName}</b><br>
                        Code : ${codeCommune}<br>
                        Prix moyen : ${prix}<br>
                        <a href="${wikiUrl}" target="_blank">Voir sur Wikipédia</a>
                    `;
                });

                layer.bindTooltip(tooltipContent, { direction: 'top', offset: [0, -10] });

                layer.on('mouseover', function () {
                    if (window.prixCommuneData[codeCommune] !== undefined) {
                        layer.setStyle({
                            weight: 3,
                            color: '#000',
                            fillOpacity: 1
                        });
                        layer.openTooltip();
                    }
                });

                layer.on('mouseout', function () {
                    if (window.prixCommuneData[codeCommune] !== undefined) {
                        window.communesLayer.resetStyle(layer);
                        layer.closeTooltip();
                    }
                });

                layer.on('click', function () {
                    var bounds = layer.getBounds();
                    window.map.fitBounds(bounds, { maxZoom: 13, animate: true });
                    window.communesLayer.resetStyle(layer);
                });

                layer.on('popupopen', function () {
                    layer.setStyle({
                        weight: 1,
                        color: 'black',
                        fillOpacity: 0.7
                    });
                });

                layer.on('popupclose', function () {
                    window.communesLayer.resetStyle(layer);
                });
            }
        }).addTo(window.map);
    }).catch(error => {
        console.error('Erreur lors du chargement des communes pour Leaflet :', error);
    });
}

// Carte 2D (Leaflet)
document.addEventListener('DOMContentLoaded', function() {
    window.map = L.map('map', {
        zoomAnimation: true,
        zoomDelta: 0.5,
        zoomSnap: 0.5,
        maxZoom: 10,
        minZoom: 6,
    }).setView([46.603354, 1.888334], 6);

    var Esri_WorldGrayCanvas = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri — Esri, DeLorme, NAVTEQ',
        maxZoom: 16
    }).addTo(window.map);

    var prixData = {};
    window.departementsLayer = null;

    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_departement.csv').then(response => response.text()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_commune.csv').then(response => response.text())
    ]).then(([deptCsvText, geojsonData, communeCsvText]) => {
        let deptRows = deptCsvText.split("\n").map(row => row.split(";"));
        deptRows.forEach(row => {
            let code_dep = row[0].trim();
            let prix = parseFloat(row[1]);
            if (!isNaN(prix)) prixData[code_dep] = prix;
        });

        let communeRows = communeCsvText.split("\n").map(row => row.split(";"));
        communeRows.forEach(row => {
            let code_commune = row[0].trim().padStart(5, '0');
            let prix = parseFloat(row[1]);
            if (!isNaN(prix)) window.prixCommuneData[code_commune] = prix;
        });

        function style(feature) {
            let code = feature.properties.code.toString().trim();
            let prix = prixData[code];
            let fillColor = prix !== undefined ? getColor(prix) : '#808080';
            return {
                fillColor: fillColor,
                weight: 1,
                opacity: 1,
                color: 'black',
                fillOpacity: 0.7
            };
        }

        window.departementsLayer = L.geoJSON(geojsonData, {
            style: style,
            onEachFeature: function (feature, layer) {
                let code = feature.properties.code.toString().padStart(2, '0');
                let prix = prixData[code] ? prixData[code].toFixed(1) + " €/m²" : "Donnée non disponible";
                let popupContent = `<b>Département : ${feature.properties.nom}</b><br>Code : ${code}<br>Prix moyen : ${prix}`;
                let tooltipContent = `${feature.properties.nom}<br>${prix}`;

                layer.bindPopup(popupContent);
                layer.bindTooltip(tooltipContent, { direction: 'top', offset: [0, -10] });

                layer.on('mouseover', function () {
                    layer.setStyle({
                        weight: 3,
                        color: '#000',
                        fillOpacity: 1
                    });
                    layer.openTooltip();
                });

                layer.on('mouseout', function () {
                    window.departementsLayer.resetStyle(layer);
                    layer.closeTooltip();
                });

                layer.on('click', function () {
                    var bounds = layer.getBounds();
                    window.map.fitBounds(bounds, { maxZoom: 9, animate: true });
                    loadCommuneLayer(code);
                    console.log("Clic sur département, code :", code);
                });

                layer.on('popupopen', function () {
                    layer.setStyle({
                        weight: 1,
                        color: 'black',
                        fillOpacity: 0.7
                    });
                });

                layer.on('popupclose', function () {
                    window.departementsLayer.resetStyle(layer);
                });
            }
        }).addTo(window.map);
    }).catch(error => {
        console.error('Erreur lors du chargement des données initiales pour Leaflet :', error);
    });

    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            grades = [1000, 1500, 2000, 2500, 3000, 3500, 4000];
        div.innerHTML += "<b>Prix du m²</b><br>";
        div.innerHTML += '<i style="background:#F5F5DC"></i> < 1000 €/m²<br>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                grades[i] + (grades[i + 1] ? '–' + grades[i + 1] + ' €/m²<br>' : '+ €/m²');
        }
        div.innerHTML += '<br><i style="background:#808080"></i> Données non disponibles<br>';
        return div;
    };
    legend.addTo(window.map);

    window.map.on('zoomend', function () {
        if (window.map.getZoom() <= 6.4) {
            if (window.communesLayer) {
                window.map.removeLayer(window.communesLayer);
            }
            if (window.departementsLayer) {
                window.map.fitBounds(window.departementsLayer.getBounds(), { maxZoom: 9, animate: true });
            } else {
                console.warn("departementsLayer n'est pas encore initialisé.");
            }
        }
    });
});

// Carte 3D (Cesium)
function initCesium() {
    var loadingSpinner = document.getElementById('loadingSpinner');
    loadingSpinner.style.display = 'block';

    var viewer = new Cesium.Viewer('map3D', {
        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
            url: 'https://a.tile.openstreetmap.org/'
        }),
        terrainProvider: null,
        baseLayerPicker: false,
        geocoder: false,
        homeButton: true,
        sceneModePicker: true,
        navigationHelpButton: true,
        animation: false,
        timeline: false,
        fullscreenButton: true,
        shadows: false,
        infoBox: true
    });

    viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString('#87CEEB');
    viewer.scene.globe.enableLighting = false;

    viewer.scene.screenSpaceCameraController.minimumZoomDistance = 500;
    viewer.scene.screenSpaceCameraController.maximumZoomDistance = 10000000;
    viewer.scene.screenSpaceCameraController.enableTilt = true;
    viewer.scene.screenSpaceCameraController.enableLook = true;
    viewer.scene.screenSpaceCameraController.inertiaSpin = 0.9;
    viewer.scene.screenSpaceCameraController.inertiaTranslate = 0.9;

    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(2.5, 46.5, 400000),
        orientation: {
            heading: Cesium.Math.toRadians(0.0),
            pitch: Cesium.Math.toRadians(-60.0),
        }
    });

    viewer.infoBox.frame.setAttribute('sandbox', 'allow-same-origin allow-popups allow-pointer-lock allow-top-navigation');

    let communeDataSource;
    let departmentDataSource = null;
    let allCommuneEntities = [];

    const domDepartments = ["971", "972", "973", "974", "975", "976", "977", "978", "986", "987", "988"];

    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_commune.csv').then(response => response.text()),
        fetch('https://www.data.gouv.fr/fr/datasets/r/fb3580f6-e875-408d-809a-ad22fc418581').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/ne_50m_admin_0_countries.geojson').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json())
    ]).then(([csvText, communeGeojsonData, countriesGeojsonData, deptGeojsonData]) => {
        let rows = csvText.split("\n").map(row => row.split(";"));
        rows.forEach(row => {
            let code_commune = row[0].trim().padStart(5, '0');
            let prix = parseFloat(row[1]);
            if (!isNaN(prix)) window.prixCommuneData[code_commune] = prix;
        });

        const countriesPromise = Cesium.GeoJsonDataSource.load(countriesGeojsonData, {
            clampToGround: true,
            stroke: Cesium.Color.BLACK,
            strokeWidth: 1,
            fill: Cesium.Color.GRAY.withAlpha(0.3)
        }).then(function(dataSource) {
            viewer.dataSources.add(dataSource);
            var entities = dataSource.entities.values;

            for (var i = 0; i < entities.length; i++) {
                var entity = entities[i];
                var countryName = entity.properties.NAME || "Nom non défini";
                var continent = entity.properties.CONTINENT || "Non spécifié";

                entity.polygon.extrudedHeight = 0;
                entity.polygon.material = Cesium.Color.GRAY.withAlpha(0.3);
                entity.polygon.outline = true;
                entity.polygon.outlineColor = Cesium.Color.BLACK;

                entity.description = new Cesium.ConstantProperty(`
                    <div class="custom-popup">
                        <h3>${countryName}</h3>
                        <p><strong>Continent :</strong> ${continent}</p>
                    </div>
                `);
            }
        }).catch(error => {
            console.error('Erreur lors du chargement des pays :', error);
        });

        communeDataSource = Cesium.GeoJsonDataSource.load(communeGeojsonData, {
            clampToGround: false
        });

        const communesPromise = communeDataSource.then(function(dataSource) {
            viewer.dataSources.add(dataSource);
            allCommuneEntities = dataSource.entities.values;
            console.log("Nombre total de communes chargées :", allCommuneEntities.length);

            let depValues = new Set();
            for (var i = 0; i < allCommuneEntities.length; i++) {
                var entity = allCommuneEntities[i];
                var dep = entity.properties._dep ? entity.properties._dep._value.toString().padStart(2, '0') : null;
                depValues.add(dep);

                if (dep && domDepartments.includes(dep)) {
                    entity.show = false;
                    continue;
                }

                var code = entity.properties._codgeo._value;
                var prix = window.prixCommuneData[code];
                var height = prix !== undefined ? prix * 30 : 0;
                var fillColor = prix !== undefined ? Cesium.Color.fromCssColorString(getColor(prix)).withAlpha(1.0) : Cesium.Color.fromCssColorString('#808080').withAlpha(1.0);

                entity.polygon.material = fillColor;
                entity.polygon.outline = true;
                entity.polygon.outlineColor = fillColor;
                entity.polygon.extrudedHeight = height;
                entity.polygon.height = 0;

                if (i === 0) {
                    console.log("Propriétés disponibles pour une commune :", Object.keys(entity.properties));
                    console.log("Valeur de _libgeo :", entity.properties._libgeo._value);
                    console.log("Valeur de _codgeo :", entity.properties._codgeo._value);
                }

                var communeName = entity.properties._libgeo ? entity.properties._libgeo._value : `Commune inconnue (Code: ${code})`;
                var dept = dep || "Non spécifié";
                var region = entity.properties._reg ? entity.properties._reg._value : "Non spécifiée";
                var prixText = prix !== undefined ? prix.toFixed(1) + " €/m²" : "Donnée non disponible";

                (function(entity, communeName, code, dept, region, prixText) {
                    entity.description = new Cesium.CallbackProperty(function(time, result) {
                        let wikiUrl = getWikipediaUrl(communeName);
                        return `
                            <div class="custom-popup">
                                <h3>${communeName}</h3>
                                <p><strong>Code commune :</strong> ${code}</p>
                                <p><strong>Département :</strong> ${dept}</p>
                                <p><strong>Région :</strong> ${region}</p>
                                <p><strong>Pays :</strong> France</p>
                                <p><strong>Continent :</strong> Europe</p>
                                <p><strong>Prix moyen :</strong> ${prixText}</p>
                                <p><a href="${wikiUrl}" target="_blank">Voir sur Wikipédia</a></p>
                            </div>
                        `;
                    }, false);
                })(entity, communeName, code, dept, region, prixText);
            }
            console.log("Valeurs uniques de 'dep' dans communes.geojson :", Array.from(depValues));

            viewer.screenSpaceEventHandler.setInputAction(function(click) {
                var pickedObject = viewer.scene.pick(click.position);
                if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
                    viewer.selectedEntity = pickedObject.id;
                } else {
                    viewer.selectedEntity = null;
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            var legendDiv = document.createElement('div');
            legendDiv.id = 'legend3D';
            legendDiv.innerHTML = `
                <b>Prix du m²</b><br>
                <div><span style="display:inline-block;width:18px;height:18px;background:#F5F5DC"></span> < 1000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FED976"></span> 1000–1500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FEB24C"></span> 1500–2000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FD8D3C"></span> 2000–2500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FC4E2A"></span> 2500–3000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#E31A1C"></span> 3000–3500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#BD0026"></span> 3500–4000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#800026"></span> > 4000 €/m²</div>
                <br><div><span style="display:inline-block;width:18px;height:18px;background:#808080"></span> Données non disponibles</div>
            `;
            document.getElementById('map3D').appendChild(legendDiv);

            var controlsDiv = document.createElement('div');
            controlsDiv.id = 'controls3D';
            controlsDiv.innerHTML = '<b>Sélectionner un département :</b>';
            var select = document.createElement('select');
            select.innerHTML = '<option value="">Toute la France</option>';
            deptGeojsonData.features.forEach(feature => {
                var option = document.createElement('option');
                option.value = feature.properties.code.toString().padStart(2, '0');
                option.text = feature.properties.nom;
                select.appendChild(option);
            });

            select.onchange = function() {
                var codeDep = select.value;
                console.log("Département sélectionné :", codeDep);

                if (departmentDataSource) {
                    viewer.dataSources.remove(departmentDataSource);
                    departmentDataSource = null;
                }

                if (allCommuneEntities.length === 0) {
                    console.warn("Les données des communes ne sont pas encore chargées.");
                    return;
                }

                for (var i = 0; i < allCommuneEntities.length; i++) {
                    allCommuneEntities[i].show = false;
                }

                if (codeDep) {
                    var depFeature = deptGeojsonData.features.find(f => f.properties.code.toString().padStart(2, '0') === codeDep);
                    var bounds = calculateBounds(depFeature);
                    viewer.camera.flyTo({ 
                        destination: bounds,
                        duration: 1.5
                    });

                    var depGeojson = {
                        type: "FeatureCollection",
                        features: [depFeature]
                    };
                    departmentDataSource = Cesium.GeoJsonDataSource.load(depGeojson, {
                        clampToGround: true,
                        stroke: Cesium.Color.YELLOW,
                        fill: Cesium.Color.TRANSPARENT,
                        strokeWidth: 5
                    }).then(function(dataSource) {
                        viewer.dataSources.add(dataSource);
                    }).catch(error => {
                        console.error('Erreur lors du chargement du contour du département :', error);
                    });

                    let visibleCount = 0;
                    for (var i = 0; i < allCommuneEntities.length; i++) {
                        var entity = allCommuneEntities[i];
                        var entityDep = entity.properties._dep ? entity.properties._dep._value.toString().padStart(2, '0') : null;
                        if (entityDep === codeDep && !domDepartments.includes(entityDep)) {
                            entity.show = true;
                            visibleCount++;
                        }
                    }
                    console.log(`Communes affichées pour ${codeDep} : ${visibleCount}`);
                    if (visibleCount === 0) {
                        console.warn(`Aucune commune trouvée pour ${codeDep}. Vérifiez les valeurs de 'dep' dans communes.geojson.`);
                    }
                } else {
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(2.5, 46.5, 400000),
                        orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-60.0) },
                        duration: 1.5
                    });
                    for (var i = 0; i < allCommuneEntities.length; i++) {
                        var entity = allCommuneEntities[i];
                        var entityDep = entity.properties._dep ? entity.properties._dep._value.toString().padStart(2, '0') : null;
                        if (!domDepartments.includes(entityDep)) {
                            entity.show = true;
                        }
                    }
                    console.log("Toutes les communes affichées (sauf DOM) :", allCommuneEntities.length);
                }
                viewer.scene.requestRender();
            };

            controlsDiv.appendChild(select);
            document.getElementById('map3D').appendChild(controlsDiv);
        }).catch(error => {
            console.error('Erreur lors du chargement des communes :', error);
        });

        Promise.all([countriesPromise, communesPromise]).then(() => {
            setTimeout(() => {
                console.log("Toutes les données sont chargées, masquage du spinner...");
                loadingSpinner.style.display = 'none';
            }, 15000);
        }).catch(error => {
            console.error('Erreur lors du chargement des données, masquage du spinner malgré l\'erreur :', error);
            loadingSpinner.style.display = 'none';
        });

    }).catch(error => {
        console.error('Erreur lors du chargement des données initiales :', error);
        loadingSpinner.style.display = 'none';
    });

    function calculateBounds(feature) {
        let coordinates = feature.geometry.coordinates;
        let minLon = Infinity, maxLon = -Infinity, minLat = Infinity, maxLat = -Infinity;

        function processCoords(coords) {
            if (Array.isArray(coords[0])) {
                coords.forEach(subCoords => processCoords(subCoords));
            } else {
                let lon = coords[0];
                let lat = coords[1];
                minLon = Math.min(minLon, lon);
                maxLon = Math.max(maxLon, lon);
                minLat = Math.min(minLat, lat);
                maxLat = Math.max(maxLat, lat);
            }
        }

        if (feature.geometry.type === "Polygon") {
            processCoords(coordinates[0]);
        } else if (feature.geometry.type === "MultiPolygon") {
            coordinates.forEach(poly => processCoords(poly[0]));
        }

        return Cesium.Rectangle.fromDegrees(minLon, minLat, maxLon, maxLat);
    }
}

// Histogramme (Chart.js) - Navigation avec zoom vers la carte 2D au clic
function initHistogram() {
    // Charger les données des prix et les noms des départements
    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_departement.csv').then(response => response.text()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json())
    ]).then(([csvText, geojsonData]) => {
        // Traiter les données des prix
        let rows = csvText.split("\n").map(row => row.split(";"));
        let prixData = {};
        rows.forEach(row => {
            let code_dep = row[0].trim();
            let prix = parseFloat(row[1]);
            if (!isNaN(prix)) prixData[code_dep] = prix;
        });

        // Créer un mapping code -> nom à partir du GeoJSON
        let deptNames = {};
        geojsonData.features.forEach(feature => {
            let code = feature.properties.code.toString().trim();
            let nom = feature.properties.nom;
            deptNames[code] = nom;
        });

        // Préparer les données pour l'histogramme
        let entries = Object.entries(prixData);

        // Trier les départements dans un ordre logique
        entries.sort((a, b) => {
            let codeA = a[0];
            let codeB = b[0];
            if (codeA === "2A" && codeB === "2B") return -1;
            if (codeA === "2B" && codeB === "2A") return 1;
            if (codeA === "2A" || codeA === "2B") return codeB.startsWith("2") ? -1 : 1;
            if (codeB === "2A" || codeB === "2B") return codeA.startsWith("2") ? 1 : -1;
            return parseInt(codeA) - parseInt(codeB);
        });

        // Créer les labels et les données triées
        let labels = entries.map(entry => `Dép. ${entry[0]}`);
        let data = entries.map(entry => entry[1]);
        let codes = entries.map(entry => entry[0]); // Garder les codes pour les tooltips et le clic

        const ctx = document.getElementById('priceHistogram').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Prix au m² (€)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Prix au m² (€)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Départements'
                        },
                        ticks: {
                            maxRotation: 90,
                            minRotation: 90,
                            font: {
                                size: 8
                            },
                            callback: function(value, index, values) {
                                return index % 2 === 0 ? labels[index] : '';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    },
                    title: {
                        display: true,
                        text: 'Prix moyen au m² par département en France'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let index = context.dataIndex;
                                let code = codes[index];
                                let nom = deptNames[code] || "Nom non disponible";
                                let prix = context.parsed.y.toFixed(1);
                                return `${nom} (Dép. ${code}) : ${prix} €/m²`;
                            }
                        }
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        let index = elements[0].index;
                        let code = codes[index];
                        let nom = deptNames[code] || "Nom non disponible";
                        console.log(`Clic sur le département ${code} (${nom})`);

                        // Changer l'onglet vers "Map2D"
                        let map2DTab = document.getElementsByClassName("tablinks")[0];
                        openTab({ currentTarget: map2DTab }, 'Map2D');

                        // Attendre que la carte soit prête et zoomer
                        setTimeout(() => {
                            if (window.map && window.departementsLayer) {
                                let feature = Object.values(window.departementsLayer._layers).find(layer => 
                                    layer.feature.properties.code.toString().padStart(2, '0') === code
                                );
                                if (feature) {
                                    // Réinitialiser la vue à la France entière avant de zoomer
                                    window.map.setView([46.603354, 1.888334], 6, { animate: true });
                                    setTimeout(() => {
                                        window.map.fitBounds(feature.getBounds(), {
                                            maxZoom: 9,
                                            animate: true,
                                            duration: 1.5 // Durée de l'animation en secondes
                                        });
                                        loadCommuneLayer(code); // Charger les communes après le zoom
                                    }, 500); // Délai pour laisser la vue initiale se réinitialiser
                                } else {
                                    console.warn(`Feature non trouvée pour le code ${code}`);
                                }
                            } else {
                                console.warn("Carte ou départementsLayer non initialisés");
                            }
                        }, 1000); // Délai pour s'assurer que l'onglet est affiché
                    }
                },
                maintainAspectRatio: false
            }
        });

        console.log("Nombre de départements dans l'histogramme :", labels.length);
    }).catch(error => {
        console.error('Erreur lors du chargement des données pour l\'histogramme :', error);
    });
}
</script>

</body>
</html>
