<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimation des Prix au m² en France</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Cesium.js"></script>
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Widgets/widgets.css" />
    <style>
        /* [Styles inchangés, omis pour brièveté] */
    </style>
</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/Logo_site.jpg" alt="Logo_site">
    <h1>Estimation des Prix au m² en France</h1>
</header>

<div class="tab">
    <button class="tablinks" onclick="openTab(event, 'Map2D')" id="defaultOpen">Carte 2D</button>
    <button class="tablinks" onclick="openTab(event, 'Map3D')">Carte 3D des prix par commune</button>
</div>

<div id="Map2D" class="tabcontent">
    <div id="map"></div>
</div>

<div id="Map3D" class="tabcontent">
    <div id="map3D"></div>
</div>

<footer>
    <p>© 2025 Votre Agence Immobilière - <a href="#">Contactez-nous</a></p>
</footer>

<script>
// Gestion des onglets
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";

    if (tabName === 'Map3D' && !window.cesiumInitialized) {
        if (typeof Cesium === 'undefined') {
            console.error("Cesium n'est pas chargé correctement. Vérifiez la balise script.");
            return;
        }
        initCesium();
        window.cesiumInitialized = true;
    }
}

document.getElementById("defaultOpen").click();

// Données partagées
var prixCommuneData = {};
function getColor(prix) {
    return prix < 1000 ? '#F5F5DC' :
           prix > 4000 ? '#800026' :
           prix > 3500 ? '#BD0026' :
           prix > 3000 ? '#E31A1C' :
           prix > 2500 ? '#FC4E2A' :
           prix > 2000 ? '#FD8D3C' :
           prix > 1500 ? '#FEB24C' :
           prix >= 1000 ? '#FED976' :
                          '#808080'; // Changé '#31a354' en '#808080' pour "données indisponibles"
}

// Carte 2D (Leaflet)
document.addEventListener('DOMContentLoaded', function() {
    var map = L.map('map', {
        zoomAnimation: true,
        zoomDelta: 0.5,
        zoomSnap: 0.5,
        maxZoom: 10,
        minZoom: 6,
    }).setView([46.603354, 1.888334], 6);

    var Esri_WorldGrayCanvas = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri — Esri, DeLorme, NAVTEQ',
        maxZoom: 16
    }).addTo(map);

    var prixData = {};
    var departementsLayer = null;
    var communesLayer = null;

    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_departement.csv').then(response => response.text()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_commune.csv').then(response => response.text())
    ]).then(([deptCsvText, geojsonData, communeCsvText]) => {
        let deptRows = deptCsvText.split("\n").map(row => row.split(";"));
        deptRows.forEach(row => {
            let code_dep = row[0].trim().padStart(2, '0');
            let prix = parseFloat(row[1]);
            if (!isNaN(prix)) prixData[code_dep] = prix;
        });

        let communeRows = communeCsvText.split("\n").map(row => row.split(";"));
        communeRows.forEach(row => {
            let code_commune = row[0].trim().padStart(5, '0'); // Normalisation à 5 chiffres (ex. "01001")
            let prix = parseFloat(row[1]);
            if (!isNaN(prix)) prixCommuneData[code_commune] = prix;
            console.log("Ajout au prixCommuneData :", code_commune, prix); // Débogage
        });

        function style(feature) {
            let code = feature.properties.code.toString().padStart(2, '0');
            let prix = prixData[code];
            let fillColor = prix !== undefined ? getColor(prix) : '#808080';
            return {
                fillColor: fillColor,
                weight: 1,
                opacity: 1,
                color: 'black',
                fillOpacity: 0.7
            };
        }

        departementsLayer = L.geoJSON(geojsonData, {
            style: style,
            onEachFeature: function (feature, layer) {
                let code = feature.properties.code.toString().padStart(2, '0');
                let prix = prixData[code] ? prixData[code].toFixed(1) + " €/m²" : "Donnée non disponible";
                let popupContent = `<b>Département : ${feature.properties.nom}</b><br>Code : ${code}<br>Prix moyen : ${prix}`;
                let tooltipContent = `${feature.properties.nom}<br>${prix}`;

                layer.bindPopup(popupContent);
                layer.bindTooltip(tooltipContent, { direction: 'top', offset: [0, -10] });

                layer.on('mouseover', function () {
                    layer.setStyle({
                        weight: 3,
                        color: '#000',
                        fillOpacity: 1
                    });
                    layer.openTooltip();
                });

                layer.on('mouseout', function () {
                    departementsLayer.resetStyle(layer);
                    layer.closeTooltip();
                });

                layer.on('click', function () {
                    var bounds = layer.getBounds();
                    map.fitBounds(bounds, { maxZoom: 9, animate: true });
                    loadCommuneLayer(code);
                    console.log("Clic sur département, code :", code);
                });

                layer.on('popupopen', function () {
                    layer.setStyle({
                        weight: 1,
                        color: 'black',
                        fillOpacity: 0.7
                    });
                });

                layer.on('popupclose', function () {
                    departementsLayer.resetStyle(layer);
                });
            }
        }).addTo(map);
    }).catch(error => {
        console.error('Erreur lors du chargement des données initiales pour Leaflet :', error);
    });

    function loadCommuneLayer(codeDepartement) {
        if (communesLayer) {
            map.removeLayer(communesLayer);
        }

        fetch('https://www.data.gouv.fr/fr/datasets/r/fb3580f6-e875-408d-809a-ad22fc418581')
        .then(response => response.json())
        .then(geojsonData => {
            console.log("Chargement des communes pour le département :", codeDepartement);
            communesLayer = L.geoJSON(geojsonData, {
                filter: function (feature) {
                    let dep = feature.properties.dep ? feature.properties.dep.toString().padStart(2, '0') : null;
                    // Exclure les DOM (codes commençant par 97, 98, etc.)
                    let isDOM = dep && (dep.startsWith('97') || dep.startsWith('98'));
                    console.log("Filtrage, dep:", dep, "vs codeDepartement:", codeDepartement, "isDOM:", isDOM);
                    return dep === codeDepartement && !isDOM;
                },
                style: function (feature) {
                    let codeCommune = feature.properties.codgeo; // Utilisation de codgeo
                    let prix = prixCommuneData[codeCommune];
                    let fillColor = prix !== undefined ? getColor(prix) : '#808080';
                    console.log("Commune:", codeCommune, "Prix:", prix, "Couleur:", fillColor); // Débogage
                    return {
                        fillColor: fillColor,
                        weight: 1,
                        opacity: 1,
                        color: 'black',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function (feature, layer) {
                    let codeCommune = feature.properties.codgeo;
                    let prix = prixCommuneData[codeCommune] ? prixCommuneData[codeCommune].toFixed(1) + " €/m²" : "Donnée non disponible";
                    let communeName = feature.properties.libgeo || 'Nom non défini';
                    let popupContent = `<b>Commune : ${communeName}</b><br>Code : ${codeCommune}<br>Prix moyen : ${prix}`;
                    let tooltipContent = `${communeName}<br>${prix}`;

                    layer.bindPopup(popupContent);
                    layer.bindTooltip(tooltipContent, { direction: 'top', offset: [0, -10] });

                    layer.on('mouseover', function () {
                        if (prixCommuneData[codeCommune] !== undefined) {
                            layer.setStyle({
                                weight: 3,
                                color: '#000',
                                fillOpacity: 1
                            });
                            layer.openTooltip();
                        }
                    });

                    layer.on('mouseout', function () {
                        if (prixCommuneData[codeCommune] !== undefined) {
                            communesLayer.resetStyle(layer);
                            layer.closeTooltip();
                        }
                    });

                    layer.on('click', function () {
                        var bounds = layer.getBounds();
                        map.fitBounds(bounds, { maxZoom: 13, animate: true });
                        communesLayer.resetStyle(layer);
                    });

                    layer.on('popupopen', function () {
                        layer.setStyle({
                            weight: 1,
                            color: 'black',
                            fillOpacity: 0.7
                        });
                    });

                    layer.on('popupclose', function () {
                        communesLayer.resetStyle(layer);
                    });
                }
            }).addTo(map);
        }).catch(error => {
            console.error('Erreur lors du chargement des communes pour Leaflet :', error);
        });
    }

    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            grades = [1000, 1500, 2000, 2500, 3000, 3500, 4000];
        div.innerHTML += "<b>Prix du m²</b><br>";
        div.innerHTML += '<i style="background:#F5F5DC"></i> < 1000 €/m²<br>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                grades[i] + (grades[i + 1] ? '–' + grades[i + 1] + ' €/m²<br>' : '+ €/m²');
        }
        div.innerHTML += '<br><i style="background:#808080"></i> Données non disponibles<br>';
        return div;
    };
    legend.addTo(map);

    map.on('zoomend', function () {
        if (map.getZoom() <= 6.4) {
            if (communesLayer) {
                map.removeLayer(communesLayer);
            }
            if (departementsLayer) {
                map.fitBounds(departementsLayer.getBounds(), { maxZoom: 9, animate: true });
            } else {
                console.warn("departementsLayer n'est pas encore initialisé.");
            }
        }
    });
});

// Carte 3D (Cesium)
function initCesium() {
    var viewer = new Cesium.Viewer('map3D', {
        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
            url: 'https://a.tile.openstreetmap.org/'
        }),
        terrainProvider: null,
        baseLayerPicker: false,
        geocoder: false,
        homeButton: true,
        sceneModePicker: true,
        navigationHelpButton: true,
        animation: false,
        timeline: false,
        fullscreenButton: true,
        shadows: false
    });

    viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString('#87CEEB');
    viewer.scene.globe.enableLighting = false;

    viewer.scene.screenSpaceCameraController.minimumZoomDistance = 500;
    viewer.scene.screenSpaceCameraController.maximumZoomDistance = 10000000;
    viewer.scene.screenSpaceCameraController.enableTilt = true;
    viewer.scene.screenSpaceCameraController.enableLook = true;
    viewer.scene.screenSpaceCameraController.inertiaSpin = 0.9;
    viewer.scene.screenSpaceCameraController.inertiaTranslate = 0.9;

    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(2.5, 46.5, 400000),
        orientation: {
            heading: Cesium.Math.toRadians(0.0),
            pitch: Cesium.Math.toRadians(-60.0),
        }
    });

    let communeDataSource;
    let departmentDataSource = null;
    let allCommuneEntities = [];

    Promise.all([
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/prix_m2_moyenne_par_commune.csv').then(response => response.text()),
        fetch('https://www.data.gouv.fr/fr/datasets/r/fb3580f6-e875-408d-809a-ad22fc418581').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/ne_50m_admin_0_countries.geojson').then(response => response.json()),
        fetch('https://raw.githubusercontent.com/Aprz00/projet_dataviz/main/contour-des-departements.geojson').then(response => response.json())
    ]).then(([csvText, communeGeojsonData, countriesGeojsonData, deptGeojsonData]) => {
        let rows = csvText.split("\n").map(row => row.split(";"));
        rows.forEach(row => {
            let code_commune = row[0].trim().padStart(5, '0'); // Normalisation à 5 chiffres (ex. "01001")
            let prix = parseFloat(row[1]);
            if (!isNaN(prix)) prixCommuneData[code_commune] = prix;
            console.log("Ajout au prixCommuneData :", code_commune, prix); // Débogage
        });

        Cesium.GeoJsonDataSource.load(countriesGeojsonData, {
            clampToGround: true,
            stroke: Cesium.Color.BLACK,
            strokeWidth: 1,
            fill: Cesium.Color.GRAY.withAlpha(0.3)
        }).then(function(dataSource) {
            viewer.dataSources.add(dataSource);
            var entities = dataSource.entities.values;
            for (var i = 0; i < entities.length; i++) {
                var entity = entities[i];
                var countryName = entity.properties.NAME || "Nom non défini";
                var continent = entity.properties.CONTINENT || "Non spécifié";
                entity.polygon.extrudedHeight = 0;
                entity.polygon.material = Cesium.Color.GRAY.withAlpha(0.3);
                entity.polygon.outline = true;
                entity.polygon.outlineColor = Cesium.Color.BLACK;
                entity.description = new Cesium.ConstantProperty(`
                    <div class="custom-popup">
                        <h3>${countryName}</h3>
                        <p><strong>Continent :</strong> ${continent}</p>
                    </div>
                `);
            }
        }).catch(error => {
            console.error('Erreur lors du chargement des pays :', error);
        });

        communeDataSource = Cesium.GeoJsonDataSource.load(communeGeojsonData, {
            clampToGround: false
        });

        communeDataSource.then(function(dataSource) {
            viewer.dataSources.add(dataSource);
            allCommuneEntities = dataSource.entities.values;
            console.log("Nombre total de communes chargées :", allCommuneEntities.length);

            let depValues = new Set();
            for (var i = 0; i < allCommuneEntities.length; i++) {
                var entity = allCommuneEntities[i];
                var dep = entity.properties.dep ? entity.properties.dep.toString().padStart(2, '0') : null;
                depValues.add(dep);
                var code = entity.properties.codgeo; // Utilisation de codgeo
                var prix = prixCommuneData[code];
                var height = prix !== undefined ? prix * 30 : 0;
                var fillColor = prix !== undefined ? Cesium.Color.fromCssColorString(getColor(prix)).withAlpha(1.0) : Cesium.Color.fromCssColorString('#808080').withAlpha(1.0);
                console.log("Commune:", code, "Prix:", prix, "Couleur:", fillColor); // Débogage

                entity.polygon.material = fillColor;
                entity.polygon.outline = true;
                entity.polygon.outlineColor = fillColor;
                entity.polygon.extrudedHeight = height;
                entity.polygon.height = 0;

                var communeName = entity.properties.libgeo || "Nom non défini";
                var region = entity.properties.reg || "Non spécifiée";
                var prixText = prix !== undefined ? prix.toFixed(1) + " €/m²" : "Donnée non disponible";

                entity.description = new Cesium.ConstantProperty(`
                    <div class="custom-popup">
                        <h3>${communeName}</h3>
                        <p><strong>Code commune :</strong> ${code}</p>
                        <p><strong>Département :</strong> ${dep}</p>
                        <p><strong>Région :</strong> ${region}</p>
                        <p><strong>Pays :</strong> France</p>
                        <p><strong>Continent :</strong> Europe</p>
                        <p><strong>Prix moyen :</strong> ${prixText}</p>
                    </div>
                `);
            }
            console.log("Valeurs uniques de 'dep' dans communes.geojson :", Array.from(depValues));

            viewer.screenSpaceEventHandler.setInputAction(function(click) {
                var pickedObject = viewer.scene.pick(click.position);
                if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
                    viewer.selectedEntity = pickedObject.id;
                } else {
                    viewer.selectedEntity = null;
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            var legendDiv = document.createElement('div');
            legendDiv.id = 'legend3D';
            legendDiv.innerHTML = `
                <b>Prix du m²</b><br>
                <div><span style="display:inline-block;width:18px;height:18px;background:#F5F5DC"></span> < 1000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FED976"></span> 1000–1500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FEB24C"></span> 1500–2000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FD8D3C"></span> 2000–2500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#FC4E2A"></span> 2500–3000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#E31A1C"></span> 3000–3500 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#BD0026"></span> 3500–4000 €/m²</div>
                <div><span style="display:inline-block;width:18px;height:18px;background:#800026"></span> > 4000 €/m²</div>
                <br><div><span style="display:inline-block;width:18px;height:18px;background:#808080"></span> Données non disponibles</div>
            `;
            document.getElementById('map3D').appendChild(legendDiv);

            var controlsDiv = document.createElement('div');
            controlsDiv.id = 'controls3D';
            controlsDiv.innerHTML = '<b>Sélectionner un département :</b>';
            var select = document.createElement('select');
            select.innerHTML = '<option value="">Toute la France</option>';
            deptGeojsonData.features.forEach(feature => {
                var option = document.createElement('option');
                option.value = feature.properties.code.toString().padStart(2, '0');
                option.text = feature.properties.nom;
                select.appendChild(option);
            });

            select.onchange = function() {
                var codeDep = select.value;
                console.log("Département sélectionné :", codeDep);

                if (departmentDataSource) {
                    viewer.dataSources.remove(departmentDataSource);
                    departmentDataSource = null;
                }

                if (allCommuneEntities.length === 0) {
                    console.warn("Les données des communes ne sont pas encore chargées.");
                    return;
                }

                for (var i = 0; i < allCommuneEntities.length; i++) {
                    allCommuneEntities[i].show = false;
                }

                if (codeDep) {
                    var depFeature = deptGeojsonData.features.find(f => f.properties.code.toString().padStart(2, '0') === codeDep);
                    var bounds = calculateBounds(depFeature);
                    viewer.camera.flyTo({
                        destination: bounds,
                        duration: 1.5
                    });

                    var depGeojson = {
                        type: "FeatureCollection",
                        features: [depFeature]
                    };
                    departmentDataSource = Cesium.GeoJsonDataSource.load(depGeojson, {
                        clampToGround: true,
                        stroke: Cesium.Color.YELLOW,
                        fill: Cesium.Color.TRANSPARENT,
                        strokeWidth: 5
                    }).then(function(dataSource) {
                        viewer.dataSources.add(dataSource);
                    }).catch(error => {
                        console.error('Erreur lors du chargement du contour du département :', error);
                    });

                    let visibleCount = 0;
                    for (var i = 0; i < allCommuneEntities.length; i++) {
                        var entity = allCommuneEntities[i];
                        var entityDep = entity.properties.dep ? entity.properties.dep.toString().padStart(2, '0') : null;
                        let isDOM = entityDep && (entityDep.startsWith('97') || entityDep.startsWith('98'));
                        if (entityDep === codeDep && !isDOM) {
                            entity.show = true;
                            visibleCount++;
                        } else {
                            console.log(`Commune ${entity.properties.libgeo || 'inconnue'} - dep: ${entityDep}, ne correspond pas à ${codeDep} (isDOM: ${isDOM})`);
                        }
                    }
                    console.log(`Communes affichées pour ${codeDep} : ${visibleCount}`);
                    if (visibleCount === 0) {
                        console.warn(`Aucune commune trouvée pour ${codeDep}. Vérifiez les données.`);
                    }
                } else {
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(2.5, 46.5, 400000),
                        orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-60.0) },
                        duration: 1.5
                    });
                    for (var i = 0; i < allCommuneEntities.length; i++) {
                        allCommuneEntities[i].show = true;
                    }
                    console.log("Toutes les communes affichées :", allCommuneEntities.length);
                }
                viewer.scene.requestRender();
            };

            controlsDiv.appendChild(select);
            document.getElementById('map3D').appendChild(controlsDiv);
        }).catch(error => {
            console.error('Erreur lors du chargement des communes :', error);
        });
    }).catch(error => {
        console.error('Erreur lors du chargement des données initiales :', error);
    });

    function calculateBounds(feature) {
        let coordinates = feature.geometry.coordinates;
        let minLon = Infinity, maxLon = -Infinity, minLat = Infinity, maxLat = -Infinity;

        function processCoords(coords) {
            if (Array.isArray(coords[0])) {
                coords.forEach(subCoords => processCoords(subCoords));
            } else {
                let lon = coords[0];
                let lat = coords[1];
                minLon = Math.min(minLon, lon);
                maxLon = Math.max(maxLon, lon);
                minLat = Math.min(minLat, lat);
                maxLat = Math.max(maxLat, lat);
            }
        }

        if (feature.geometry.type === "Polygon") {
            processCoords(coordinates[0]);
        } else if (feature.geometry.type === "MultiPolygon") {
            coordinates.forEach(poly => processCoords(poly[0]));
        }

        return Cesium.Rectangle.fromDegrees(minLon, minLat, maxLon, maxLat);
    }
}
</script>

</body>
</html>
